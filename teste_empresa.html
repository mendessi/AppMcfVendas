<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Acesso à Empresa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            background-color: #f5f5f5;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        input {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .result {
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
            padding: 10px 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .error {
            border-left: 4px solid #f44336;
        }
        .field {
            margin-bottom: 15px;
        }
        .label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Teste de Acesso à Empresa</h1>
            <p>Esta ferramenta permite testar o acesso à empresa selecionada na sessão atual.</p>
        </div>

        <div class="card">
            <h2>Login</h2>
            <div class="field">
                <label class="label" for="username">Usuário:</label>
                <input type="text" id="username" placeholder="Digite seu usuário">
            </div>
            <div class="field">
                <label class="label" for="password">Senha:</label>
                <input type="password" id="password" placeholder="Digite sua senha">
            </div>
            <button id="login-btn">Login</button>
            <div id="login-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>Empresas Disponíveis</h2>
            <button id="list-empresas-btn">Listar Empresas</button>
            <div id="empresas-list" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>Selecionar Empresa</h2>
            <div class="field">
                <label class="label" for="empresa-codigo">Código da Empresa:</label>
                <input type="number" id="empresa-codigo" placeholder="Digite o código da empresa">
            </div>
            <button id="select-empresa-btn">Selecionar Empresa</button>
            <div id="select-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>Testar Acesso à Empresa Atual</h2>
            <button id="test-empresa-btn">Testar Empresa Atual</button>
            <div id="test-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>Testar Top Clientes</h2>
            <div class="field">
                <label class="label" for="data-inicial">Data Inicial:</label>
                <input type="date" id="data-inicial" value="2025-05-01">
            </div>
            <div class="field">
                <label class="label" for="data-final">Data Final:</label>
                <input type="date" id="data-final" value="2025-05-31">
            </div>
            <button id="test-top-clientes-btn">Testar Top Clientes</button>
            <div id="top-clientes-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>Verificar Cabeçalhos</h2>
            <p>Verifica se os cabeçalhos estão sendo enviados corretamente nas requisições.</p>
            <button id="test-headers-btn">Testar Cabeçalhos</button>
            <div id="headers-result" class="result" style="display: none;"></div>
        </div>

        <div class="card" style="background-color: #f0f8ff;">
            <h2>Testar Conexão ao Banco</h2>
            <p>Testa a conexão com o banco de dados da empresa passo a passo.</p>
            <button id="test-conexao-btn">Testar Conexão</button>
            <div id="conexao-result" class="result" style="display: none;"></div>
        </div>

        <div class="card" style="background-color: #f5f5f5;">
            <h2>Gerenciar Empresas</h2>
            <p>Cria ou lista empresas no banco de dados para teste.</p>
            <div class="button-group">
                <button id="listar-empresas-btn">Listar Empresas</button>
                <button id="criar-empresa-teste-btn">Criar Empresa Teste</button>
            </div>
            <div id="empresas-result" class="result" style="display: none;"></div>
        </div>

        <div class="card" style="background-color: #e6f7ff;">
            <h2>Salvar Empresa na Sessão</h2>
            <p>Salva a empresa na sessão do usuário (necessário para alguns endpoints).</p>
            <div class="field">
                <label class="label" for="session-empresa-codigo">Código da Empresa:</label>
                <input type="number" id="session-empresa-codigo" value="1">
            </div>
            <button id="salvar-session-btn">Salvar na Sessão</button>
            <div id="session-result" class="result" style="display: none;"></div>
        </div>

        <div class="card" style="background-color: #fff0f0;">
            <h2>⚡ Teste Super Simples ⚡</h2>
            <p>Tentativa direta de salvar empresa na sessão sem dependências.</p>
            <div class="field">
                <label class="label" for="simples-empresa-codigo">Código da Empresa:</label>
                <input type="number" id="simples-empresa-codigo" value="1">
            </div>
            <button id="teste-simples-btn" style="background-color: #ff4500; font-weight: bold;">TESTE SIMPLES</button>
            <div id="simples-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let authToken = localStorage.getItem('token') || '';
        
        // Login
        document.getElementById('login-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');
            
            if (!username || !password) {
                resultDiv.textContent = 'Por favor, preencha usuário e senha';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Fazendo login...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                // Usar XMLHttpRequest para contornar limitações CORS com arquivos locais
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/login`, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                // Não usar withCredentials em arquivos locais para evitar erros CORS
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            authToken = data.access_token;
                            localStorage.setItem('token', authToken);
                            resultDiv.textContent = `Login bem-sucedido!\nToken: ${authToken.substring(0, 15)}...`;
                        } catch (e) {
                            resultDiv.textContent = `Erro ao processar resposta: ${e.message}`;
                            resultDiv.classList.add('error');
                        }
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Erro no login: ${errorData.detail || 'Erro desconhecido'}`;
                        } catch (e) {
                            resultDiv.textContent = `Erro no login: ${xhr.status} ${xhr.statusText}`;
                        }
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao tentar login`;
                    resultDiv.classList.add('error');
                };
                
                // Enviar dados no formato JSON
                xhr.send(JSON.stringify({
                    email: username,
                    senha: password
                }));
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Selecionar Empresa
        document.getElementById('select-empresa-btn').addEventListener('click', () => {
            const empresaCodigo = document.getElementById('empresa-codigo').value;
            const resultDiv = document.getElementById('select-result');
            
            if (!empresaCodigo) {
                resultDiv.textContent = 'Por favor, informe o código da empresa';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Selecionando empresa...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/teste-selecionar-simples`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                // Não usar withCredentials em arquivos locais para evitar erros CORS
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Empresa selecionada com sucesso!\nDetalhes: ${JSON.stringify(data, null, 2)}`;
                            // Armazenar código da empresa
                            localStorage.setItem('empresaCodigo', empresaCodigo);
                        } catch (e) {
                            resultDiv.textContent = `Erro ao processar resposta: ${e.message}`;
                            resultDiv.classList.add('error');
                        }
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Erro ao selecionar empresa: ${errorData.detail || 'Erro desconhecido'}`;
                        } catch (e) {
                            resultDiv.textContent = `Erro ao selecionar empresa: ${xhr.status} ${xhr.statusText}`;
                        }
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao selecionar empresa`;
                    resultDiv.classList.add('error');
                };
                
                // Usar o endpoint simplificado que requer apenas o código da empresa
                xhr.send(JSON.stringify({
                    cli_codigo: parseInt(empresaCodigo)
                }));
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Testar Empresa Atual
        document.getElementById('test-empresa-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('test-result');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Testando acesso à empresa atual...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                // Obter código da empresa se disponível
                const empresaCodigo = localStorage.getItem('empresaCodigo');
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/teste-empresa-atual`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                
                // Adicionar cabeçalho x-empresa-codigo se disponível
                if (empresaCodigo) {
                    xhr.setRequestHeader('x-empresa-codigo', empresaCodigo);
                }
                
                // Não usar withCredentials em arquivos locais para evitar erros CORS
                
                xhr.onload = function() {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        resultDiv.textContent = JSON.stringify(data, null, 2);
                        
                        if (!data.sucesso) {
                            resultDiv.classList.add('error');
                        }
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao testar empresa atual`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Listar Empresas
        document.getElementById('list-empresas-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('empresas-list');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Buscando empresas disponíveis...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/teste-listar-empresas`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            
                            if (response.sucesso && response.empresas && response.empresas.length > 0) {
                                // Mostrar informações do usuário
                                let infoHTML = '';
                                if (response.usuario) {
                                    infoHTML = `<p>Usuário: ${response.usuario.email} (ID: ${response.usuario.id})</p>`;
                                }
                                infoHTML += `<p>${response.mensagem}</p>`;
                                
                                // Criar tabela de empresas
                                let tableHTML = infoHTML;
                                tableHTML += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                                tableHTML += '<thead><tr><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Código</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nome</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">IP/Caminho</th></tr></thead>';
                                tableHTML += '<tbody>';
                                
                                response.empresas.forEach(empresa => {
                                    tableHTML += `<tr style="cursor: pointer; hover: background-color: #f5f5f5;" onclick="selectCompany(${empresa.cli_codigo})">`;
                                    tableHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${empresa.cli_codigo}</td>`;
                                    tableHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${empresa.cli_nome}</td>`;
                                    tableHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${empresa.cli_ip_servidor}/${empresa.cli_nome_base}</td>`;
                                    tableHTML += '</tr>';
                                });
                                
                                tableHTML += '</tbody></table>';
                                tableHTML += '<p style="margin-top: 10px; font-size: 0.8em;">Clique em uma empresa para selecioná-la</p>';
                                
                                resultDiv.innerHTML = tableHTML;
                            } else {
                                resultDiv.innerHTML = `<p>${response.mensagem || 'Nenhuma empresa encontrada para o usuário atual.'}</p>`;
                            }
                        } catch (e) {
                            resultDiv.textContent = `Erro ao processar lista de empresas: ${e.message}`;
                            resultDiv.classList.add('error');
                        }
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Erro ao buscar empresas: ${errorData.detail || 'Erro desconhecido'}`;
                        } catch (e) {
                            resultDiv.textContent = `Erro ao buscar empresas: ${xhr.status} ${xhr.statusText}`;
                        }
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao buscar empresas`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Função para selecionar uma empresa da tabela
        function selectCompany(codigo) {
            const resultDiv = document.getElementById('select-result');
            document.getElementById('empresa-codigo').value = codigo;
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Selecionando empresa...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/teste-selecionar-simples`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Empresa ${codigo} selecionada com sucesso!\nDetalhes: ${JSON.stringify(data, null, 2)}`;
                            // Armazenar código da empresa
                            localStorage.setItem('empresaCodigo', codigo);
                        } catch (e) {
                            resultDiv.textContent = `Erro ao processar resposta: ${e.message}`;
                            resultDiv.classList.add('error');
                        }
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            resultDiv.textContent = `Erro ao selecionar empresa: ${errorData.detail || 'Erro desconhecido'}`;
                        } catch (e) {
                            resultDiv.textContent = `Erro ao selecionar empresa: ${xhr.status} ${xhr.statusText}`;
                        }
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao selecionar empresa`;
                    resultDiv.classList.add('error');
                };
                
                // Usar o endpoint simplificado
                xhr.send(JSON.stringify({
                    cli_codigo: parseInt(codigo)
                }));
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        }
        
        // Testar Top Clientes
        document.getElementById('test-top-clientes-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('top-clientes-result');
            const dataInicial = document.getElementById('data-inicial').value;
            const dataFinal = document.getElementById('data-final').value;
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Buscando top clientes...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                // Obter código da empresa do localStorage
                const empresaCodigo = localStorage.getItem('empresaCodigo');
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/relatorios/top-clientes?data_inicial=${dataInicial}&data_final=${dataFinal}`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                // Adicionar cabeçalho de empresa se disponível
                if (empresaCodigo) {
                    xhr.setRequestHeader('x-empresa-codigo', empresaCodigo);
                }
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        // Mostrar informações básicas
                        let html = `<p>Período: ${response.data_inicial} a ${response.data_final}</p>`;
                        
                        // Verificar se há clientes
                        if (response.top_clientes && response.top_clientes.length > 0) {
                            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                            html += '<thead><tr><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Cliente</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Cidade/UF</th><th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Compras</th><th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Total</th></tr></thead>';
                            html += '<tbody>';
                            
                            response.top_clientes.forEach(cliente => {
                                const total = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(cliente.total);
                                
                                html += `<tr style="border: 1px solid #ddd;">`;
                                html += `<td style="padding: 8px;">${cliente.nome}</td>`;
                                html += `<td style="padding: 8px;">${cliente.cidade}/${cliente.uf}</td>`;
                                html += `<td style="padding: 8px; text-align: right;">${cliente.qtde_compras}</td>`;
                                html += `<td style="padding: 8px; text-align: right;">${total}</td>`;
                                html += '</tr>';
                            });
                            
                            html += '</tbody></table>';
                            
                            // Adicionar informação sobre dados reais ou exemplo
                            if (response.top_clientes[0].nome.includes('ABC Supermercados') || 
                                response.top_clientes[0].nome.includes('Distribuidora XYZ')) {
                                html += '<p style="color: orange; margin-top: 10px;">Atenção: Estes parecem ser dados de exemplo.</p>';
                            } else {
                                html += '<p style="color: green; margin-top: 10px;">Dados reais carregados com sucesso!</p>';
                            }
                        } else {
                            html += '<p>Nenhum cliente encontrado no período.</p>';
                        }
                        
                        resultDiv.innerHTML = html;
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao buscar top clientes`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Testar Cabeçalhos
        document.getElementById('test-headers-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('headers-result');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Verificando cabeçalhos...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                // Obter código da empresa do localStorage
                const empresaCodigo = localStorage.getItem('empresaCodigo');
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/teste-cabecalhos`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                // Adicionar cabeçalho de empresa se disponível
                if (empresaCodigo) {
                    xhr.setRequestHeader('x-empresa-codigo', empresaCodigo);
                }
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        let html = '<h3>Cabeçalhos Detectados</h3>';
                        
                        // Destacar informações importantes
                        const empresaHeader = response.destaque.x_empresa_codigo;
                        const authHeader = response.destaque.authorization_present;
                        
                        html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #2196F3;">';
                        html += `<p><strong>Authorization:</strong> ${authHeader ? '<span style="color: green;">Presente ✓</span>' : '<span style="color: red;">Ausente ✗</span>'}</p>`;
                        html += `<p><strong>x-empresa-codigo:</strong> ${empresaHeader !== 'NÃO ENCONTRADO' ? `<span style="color: green;">${empresaHeader} ✓</span>` : '<span style="color: red;">Ausente ✗</span>'}</p>`;
                        html += '</div>';
                        
                        // Mostrar todos os cabeçalhos
                        html += '<h4>Todos os cabeçalhos</h4>';
                        html += '<ul style="list-style-type: none; padding: 0;">';
                        
                        for (const [key, value] of Object.entries(response.headers)) {
                            // Ocultável parcialmente o Authorization para segurança
                            let displayValue = value;
                            if (key.toLowerCase() === 'authorization' && value.length > 20) {
                                displayValue = value.substring(0, 15) + '...';
                            }
                            html += `<li><strong>${key}:</strong> ${displayValue}</li>`;
                        }
                        
                        html += '</ul>';
                        
                        resultDiv.innerHTML = html;
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao testar cabeçalhos`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Testar Conexão ao Banco
        document.getElementById('test-conexao-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('conexao-result');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Testando conexão com o banco de dados...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                // Obter código da empresa do localStorage
                const empresaCodigo = localStorage.getItem('empresaCodigo');
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/teste-conexao`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                // Adicionar cabeçalho de empresa se disponível
                if (empresaCodigo) {
                    xhr.setRequestHeader('x-empresa-codigo', empresaCodigo);
                }
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        let html = '<h3>Resultados do Teste de Conexão</h3>';
                        
                        // Ver se teste foi bem-sucedido
                        if (response.sucesso) {
                            html += '<div style="background-color: #e6ffe6; padding: 10px; margin: 10px 0; border-left: 4px solid #00cc00;">';
                            html += `<p><strong>Status:</strong> <span style="color: #00cc00;">${response.mensagem}</span></p>`;
                            html += '</div>';
                            
                            // Detalhes da empresa
                            if (response.empresa) {
                                html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #2196F3;">';
                                html += '<h4>Detalhes da Empresa</h4>';
                                html += `<p><strong>Nome:</strong> ${response.empresa.nome}</p>`;
                                html += `<p><strong>IP:</strong> ${response.empresa.ip}, <strong>Porta:</strong> ${response.empresa.porta}</p>`;
                                html += `<p><strong>Base:</strong> ${response.empresa.nome_base}</p>`;
                                html += `<p><strong>Caminho:</strong> ${response.empresa.caminho_base}</p>`;
                                html += '</div>';
                            }
                            
                            // Resultados dos testes
                            html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0;">';
                            html += '<h4>Resultados por Etapa</h4>';
                            html += '<ul style="list-style-type: none; padding: 0;">';
                            
                            // Teste de conexão
                            if (response.teste_conexao === 'SUCESSO') {
                                html += '<li><span style="color: green;">&#10004;</span> <strong>Conexão com o banco:</strong> Sucesso</li>';
                            } else {
                                html += '<li><span style="color: red;">&#10008;</span> <strong>Conexão com o banco:</strong> Falha</li>';
                            }
                            
                            // Teste de consulta simples
                            if (response.teste_consulta_simples === 'SUCESSO') {
                                html += '<li><span style="color: green;">&#10004;</span> <strong>Consulta simples:</strong> Sucesso</li>';
                            } else if (response.teste_consulta_simples === 'ERRO') {
                                html += '<li><span style="color: red;">&#10008;</span> <strong>Consulta simples:</strong> Falha</li>';
                            }
                            
                            // Teste de consulta à tabela CLIENTES
                            if (response.teste_consulta_clientes === 'SUCESSO') {
                                html += '<li><span style="color: green;">&#10004;</span> <strong>Consulta CLIENTES:</strong> Sucesso</li>';
                            } else if (response.teste_consulta_clientes === 'ERRO') {
                                html += '<li><span style="color: red;">&#10008;</span> <strong>Consulta CLIENTES:</strong> Falha</li>';
                            } else if (response.teste_consulta_clientes === 'SEM DADOS') {
                                html += '<li><span style="color: orange;">&#9888;</span> <strong>Consulta CLIENTES:</strong> Nenhum dado encontrado</li>';
                            }
                            
                            html += '</ul>';
                            html += '</div>';
                            
                            // Primeiro cliente (se encontrado)
                            if (response.primeiro_cliente) {
                                html += '<div style="background-color: #f0f8ff; padding: 10px; margin: 10px 0; border: 1px solid #ccc;">';
                                html += '<h4>Primeiro Cliente Encontrado</h4>';
                                html += `<p><strong>Código:</strong> ${response.primeiro_cliente.codigo}</p>`;
                                html += `<p><strong>Nome:</strong> ${response.primeiro_cliente.nome}</p>`;
                                html += '</div>';
                            }
                            
                        } else {
                            // Teste falhou
                            html += '<div style="background-color: #ffe6e6; padding: 10px; margin: 10px 0; border-left: 4px solid #cc0000;">';
                            html += `<p><strong>Erro:</strong> <span style="color: #cc0000;">${response.mensagem}</span></p>`;
                            html += '</div>';
                            
                            // Ainda exibir os detalhes que temos
                            if (response.empresa) {
                                html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #2196F3;">';
                                html += '<h4>Detalhes da Empresa</h4>';
                                html += `<p><strong>Nome:</strong> ${response.empresa.nome}</p>`;
                                html += `<p><strong>IP:</strong> ${response.empresa.ip}, <strong>Porta:</strong> ${response.empresa.porta}</p>`;
                                html += `<p><strong>Base:</strong> ${response.empresa.nome_base}</p>`;
                                html += `<p><strong>Caminho:</strong> ${response.empresa.caminho_base}</p>`;
                                html += '</div>';
                            } else if (response.headers) {
                                html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0;">';
                                html += '<h4>Cabeçalhos Detectados</h4>';
                                html += `<p><strong>Authorization:</strong> ${response.headers.authorization_present ? 'Presente' : 'Ausente'}</p>`;
                                html += `<p><strong>x-empresa-codigo:</strong> ${response.headers['x-empresa-codigo']}</p>`;
                                html += '</div>';
                            }
                        }
                        
                        resultDiv.innerHTML = html;
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao testar conexão com o banco`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Listar empresas cadastradas
        document.getElementById('listar-empresas-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('empresas-result');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Buscando empresas cadastradas...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/empresas`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        let html = '<h3>Empresas Cadastradas</h3>';
                        
                        if (response.sucesso) {
                            if (response.total > 0) {
                                html += `<p>Total de empresas: ${response.total}</p>`;
                                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                                html += '<thead><tr><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Código</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nome</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">IP</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Base</th></tr></thead>';
                                html += '<tbody>';
                                
                                response.empresas.forEach(empresa => {
                                    html += `<tr style="border: 1px solid #ddd;">`;
                                    html += `<td style="padding: 8px;">${empresa.cli_codigo}</td>`;
                                    html += `<td style="padding: 8px;">${empresa.cli_nome}</td>`;
                                    html += `<td style="padding: 8px;">${empresa.cli_ip_servidor}</td>`;
                                    html += `<td style="padding: 8px;">${empresa.cli_nome_base}</td>`;
                                    html += '</tr>';
                                });
                                
                                html += '</tbody></table>';
                            } else {
                                html += '<p>Nenhuma empresa encontrada no banco de dados.</p>';
                                html += '<p><strong>Importante:</strong> Clique em "Criar Empresa Teste" para criar uma empresa com código 1.</p>';
                            }
                        } else {
                            html += `<p class="error">Erro: ${response.mensagem || 'Erro desconhecido'}</p>`;
                        }
                        
                        resultDiv.innerHTML = html;
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao listar empresas`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Criar empresa de teste
        document.getElementById('criar-empresa-teste-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('empresas-result');
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Criando empresa de teste...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', `${API_URL}/cria-empresa-teste`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.sucesso) {
                            let html = '<h3>Empresa Criada com Sucesso</h3>';
                            html += '<div style="background-color: #e6ffe6; padding: 10px; margin: 10px 0; border-left: 4px solid #00cc00;">';
                            html += `<p><strong>Mensagem:</strong> ${response.mensagem}</p>`;
                            html += '</div>';
                            
                            if (response.empresa) {
                                html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0;">';
                                html += '<h4>Dados da Empresa</h4>';
                                html += `<p><strong>Código:</strong> ${response.empresa.cli_codigo}</p>`;
                                html += `<p><strong>Nome:</strong> ${response.empresa.cli_nome}</p>`;
                                
                                if (response.empresa.detalhes) {
                                    html += '<h4>Detalhes da Conexão</h4>';
                                    html += `<p><strong>IP:</strong> ${response.empresa.detalhes.cli_ip_servidor}</p>`;
                                    html += `<p><strong>Porta:</strong> ${response.empresa.detalhes.cli_porta}</p>`;
                                    html += `<p><strong>Base:</strong> ${response.empresa.detalhes.cli_nome_base}</p>`;
                                    html += `<p><strong>Caminho:</strong> ${response.empresa.detalhes.cli_caminho_base}</p>`;
                                }
                                
                                html += '</div>';
                            }
                            
                            html += '<p>Agora você pode testar a conexão com a empresa!</p>';
                            resultDiv.innerHTML = html;
                        } else {
                            resultDiv.textContent = `Erro: ${response.mensagem || 'Erro desconhecido'}`;
                            resultDiv.classList.add('error');
                        }
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao criar empresa de teste`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send();
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Salvar empresa na sessão
        document.getElementById('salvar-session-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('session-result');
            const empresaCodigo = document.getElementById('session-empresa-codigo').value;
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            if (!empresaCodigo) {
                resultDiv.textContent = 'Informe o código da empresa';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Salvando empresa na sessão...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/selecionar-empresa-session`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.sucesso) {
                            let html = '<h3>Empresa Salva na Sessão</h3>';
                            html += '<div style="background-color: #e6ffe6; padding: 10px; margin: 10px 0; border-left: 4px solid #00cc00;">';
                            html += `<p><strong>Mensagem:</strong> ${response.mensagem}</p>`;
                            html += '</div>';
                            
                            if (response.empresa) {
                                html += '<div style="background-color: #f5f5f5; padding: 10px; margin: 10px 0;">';
                                html += '<h4>Dados da Empresa na Sessão</h4>';
                                html += `<p><strong>Código:</strong> ${response.empresa.cli_codigo}</p>`;
                                html += `<p><strong>Nome:</strong> ${response.empresa.cli_nome}</p>`;
                                html += `<p><strong>IP:</strong> ${response.empresa.cli_ip_servidor}</p>`;
                                html += `<p><strong>Base:</strong> ${response.empresa.cli_nome_base}</p>`;
                                html += '</div>';
                            }
                            
                            if (response.debug_info) {
                                html += '<div style="background-color: #f0f8ff; padding: 10px; margin: 10px 0; border: 1px solid #ccc;">';
                                html += '<h4>Debug Info</h4>';
                                html += `<p><strong>Usuário ID:</strong> ${response.debug_info.usuario_id}</p>`;
                                html += `<p><strong>Empresas na sessão global:</strong> ${response.debug_info.empresa_sessions_count}</p>`;
                                html += `<p><strong>Empresa presente na sessão:</strong> ${response.debug_info.empresa_in_session ? 'Sim' : 'Não'}</p>`;
                                html += '</div>';
                            }
                            
                            html += '<p>Agora você pode testar a conexão com o banco de dados!</p>';
                            resultDiv.innerHTML = html;
                            
                            // Armazenar código da empresa no localStorage também
                            localStorage.setItem('empresaCodigo', empresaCodigo);
                        } else {
                            resultDiv.textContent = `Erro: ${response.mensagem || 'Erro desconhecido'}`;
                            resultDiv.classList.add('error');
                        }
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede ao salvar empresa na sessão`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send(JSON.stringify({
                    cli_codigo: parseInt(empresaCodigo)
                }));
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Teste Super Simples
        document.getElementById('teste-simples-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('simples-result');
            const empresaCodigo = document.getElementById('simples-empresa-codigo').value;
            
            if (!authToken) {
                resultDiv.textContent = 'Você precisa fazer login primeiro';
                resultDiv.classList.add('error');
                resultDiv.style.display = 'block';
                return;
            }
            
            try {
                resultDiv.textContent = 'Executando teste super simples...';
                resultDiv.classList.remove('error');
                resultDiv.style.display = 'block';
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${API_URL}/salvar-empresa-simples`, true);
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.sucesso) {
                            resultDiv.innerHTML = `
                                <div style="color: green; font-weight: bold;">SUCESSO!</div>
                                <pre style="background-color: #f0f0f0; padding: 10px;">${JSON.stringify(response, null, 2)}</pre>
                            `;
                            
                            // Armazenar código da empresa no localStorage também
                            localStorage.setItem('empresaCodigo', empresaCodigo);
                        } else {
                            resultDiv.innerHTML = `
                                <div style="color: red; font-weight: bold;">ERRO!</div>
                                <pre style="background-color: #f0f0f0; padding: 10px;">${JSON.stringify(response, null, 2)}</pre>
                            `;
                            resultDiv.classList.add('error');
                        }
                    } catch (e) {
                        resultDiv.textContent = `Erro ao processar resposta: ${e.message}\n${xhr.responseText}`;
                        resultDiv.classList.add('error');
                    }
                };
                
                xhr.onerror = function() {
                    resultDiv.textContent = `Erro de rede no teste simples`;
                    resultDiv.classList.add('error');
                };
                
                xhr.send(JSON.stringify({
                    codigo: parseInt(empresaCodigo),
                    nome: "SANTOS INDUSTRIA",
                    ip: "149.56.77.81",
                    porta: "3050",
                    caminho_base: "C:\\ERP_MACFIN\\Banco\\Santos",
                    nome_base: "BASE_PRI.GDB"
                }));
            } catch (error) {
                resultDiv.textContent = `Erro: ${error.message}`;
                resultDiv.classList.add('error');
            }
        });
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se tem token salvo
            if (authToken) {
                document.getElementById('login-result').textContent = `Token existente: ${authToken.substring(0, 15)}...`;
                document.getElementById('login-result').style.display = 'block';
            }
            
            // Verificar se tem empresa salva
            const empresaCodigo = localStorage.getItem('empresaCodigo');
            if (empresaCodigo) {
                document.getElementById('empresa-codigo').value = empresaCodigo;
            }
        });
    </script>
</body>
</html>
